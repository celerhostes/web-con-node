<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago - CelerHost</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.paypal.com/sdk/js?client-id=AdJBMeq8ZQp_UydMjZx5CcPiqqWmSL1yaHeyxmEUkjTlJoFM1mqitTOggqmYWmO6A81RhNtIrl3v0u4Hcurrency=USD"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00ff88;
            --primary-dark: #00cc6a;
            --dark: #0f0f0f;
            --dark-light: #1a1a1a;
            --dark-lighter: #2d2d2d;
            --text: #ffffff;
            --text-light: #cccccc;
            --error: #ff4444;
            --success: #00ff88;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark);
            color: var(--text);
            min-height: 100vh;
        }

        .navbar {
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            border-bottom: 2px solid var(--primary);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            color: var(--primary);
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .payment-card {
            background: var(--dark-light);
            border-radius: 15px;
            border: 1px solid #333;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .payment-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .payment-header h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .payment-header p {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .plan-details {
            background: var(--dark-lighter);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        .plan-name {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .plan-features {
            list-style: none;
            margin: 1rem 0;
        }

        .plan-features li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #333;
            color: var(--text-light);
        }

        .plan-features li:last-child {
            border-bottom: none;
        }

        .plan-price {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            margin: 1.5rem 0;
        }

        .payment-options {
            text-align: center;
        }

        #paypal-button-container {
            margin: 2rem 0;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .loading i {
            color: var(--primary);
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .alert.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert.error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .payment-header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-server"></i>
                CelerHost
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <div class="payment-card">
            <div class="payment-header">
                <h1>Completa tu Pago</h1>
                <p>Estás a un paso de activar tu servidor de juego</p>
            </div>

            <div id="alert" class="alert"></div>

            <div id="loading" class="loading">
                <i class="fas fa-spinner"></i>
                <p>Procesando pago...</p>
            </div>

            <div id="paymentContent">
                <div class="plan-details">
                    <h2 class="plan-name" id="planName">Cargando...</h2>
                    <ul class="plan-features" id="planFeatures">
                        <li><i class="fas fa-spinner fa-spin"></i> Cargando detalles del plan...</li>
                    </ul>
                    <div class="plan-price" id="planPrice">$--.--</div>
                </div>

                <div class="payment-options">
                    <h3 style="color: var(--text-light); margin-bottom: 1rem;">Método de Pago</h3>
                    <div id="paypal-button-container"></div>
                    <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 1rem;">
                        <i class="fas fa-lock"></i> Pago seguro procesado por PayPal
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Obtener parámetros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const planId = urlParams.get('plan_id');

        // Elementos del DOM
        const elements = {
            loading: document.getElementById('loading'),
            paymentContent: document.getElementById('paymentContent'),
            alert: document.getElementById('alert'),
            planName: document.getElementById('planName'),
            planFeatures: document.getElementById('planFeatures'),
            planPrice: document.getElementById('planPrice')
        };

        // Mostrar alerta
        function showAlert(message, type = 'success') {
            elements.alert.textContent = message;
            elements.alert.className = `alert ${type}`;
            elements.alert.style.display = 'block';
        }

        // Ocultar alerta
        function hideAlert() {
            elements.alert.style.display = 'none';
        }

        // Cargar información del plan
        async function loadPlanDetails() {
            if (!planId) {
                showAlert('No se especificó un plan', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                // Verificar autenticación
                const authResponse = await fetch('/api/auth/verify', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const authData = await authResponse.json();
                if (!authData.valid) {
                    window.location.href = '/login';
                    return;
                }

                // Obtener detalles del plan
                const response = await fetch('/api/planes');
                const plans = await response.json();
                const plan = plans.find(p => p.id == planId);

                if (!plan) {
                    showAlert('Plan no encontrado', 'error');
                    return;
                }

                // Mostrar detalles del plan
                elements.planName.textContent = plan.nombre;
                elements.planPrice.textContent = `$${plan.precio}/mes`;
                
                elements.planFeatures.innerHTML = `
                    <li><i class="fas fa-users"></i> ${plan.slots_jugadores} Slots de Jugadores</li>
                    <li><i class="fas fa-memory"></i> ${plan.ram}MB RAM DDR4</li>
                    <li><i class="fas fa-hdd"></i> ${plan.almacenamiento}MB Almacenamiento SSD</li>
                    <li><i class="fas fa-shield-alt"></i> Protección DDoS Avanzada</li>
                    <li><i class="fas fa-headset"></i> Soporte 24/7</li>
                `;

                // Inicializar botón de PayPal
                initializePayPalButton(plan);

                elements.loading.style.display = 'none';
                elements.paymentContent.style.display = 'block';

            } catch (error) {
                console.error('Error loading plan details:', error);
                showAlert('Error cargando detalles del plan', 'error');
            }
        }

        // Inicializar botón de PayPal
        function initializePayPalButton(plan) {
            paypal.Buttons({
                createOrder: function(data, actions) {
                    return fetch('/api/payments/create-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            plan_id: plan.id
                        })
                    }).then(function(res) {
                        return res.json();
                    }).then(function(data) {
                        if (data.success) {
                            return data.orderID;
                        } else {
                            throw new Error(data.error || 'Error creating order');
                        }
                    });
                },

                onApprove: function(data, actions) {
                    elements.loading.style.display = 'block';
                    elements.paymentContent.style.display = 'none';
                    hideAlert();

                    return fetch('/api/payments/capture-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            orderID: data.orderID
                        })
                    }).then(function(res) {
                        return res.json();
                    }).then(function(details) {
                        if (details.success) {
                            showAlert('¡Pago completado exitosamente! Redirigiendo...', 'success');
                            
                            // Redirigir al dashboard después de 3 segundos
                            setTimeout(() => {
                                window.location.href = '/dashboard';
                            }, 3000);
                        } else {
                            throw new Error(details.error || 'Error capturing payment');
                        }
                    });
                },

                onError: function(err) {
                    console.error('PayPal error:', err);
                    showAlert('Error en el proceso de pago: ' + err.message, 'error');
                },

                onCancel: function(data) {
                    showAlert('Pago cancelado por el usuario', 'error');
                }

            }).render('#paypal-button-container');
        }

        // Inicializar cuando la página cargue
        document.addEventListener('DOMContentLoaded', loadPlanDetails);
    </script>
</body>
</html>